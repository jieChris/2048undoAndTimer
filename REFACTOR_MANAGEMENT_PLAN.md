# 2048 重构项目管理文档（v2）

最后更新：2026-02-23  
负责人：项目 Owner（你）  
状态：Draft / 可执行

---

## 1. 文档目的

本文件用于管理 `2048-next` 重构项目，确保：

1. 老项目可持续维护，不因重构影响线上可用性。
2. 新项目按阶段交付、可验证、可回滚。
3. 团队（即使只有 1 人）也能基于统一清单推进。

---

## 2. 当前问题与重构必要性

当前仓库已出现典型高耦合特征：

1. 核心逻辑与 DOM/UI/存储强耦合（维护风险高）。
2. 输入管理、应用入口、页面脚本存在重复实现。
3. 大量内联样式 + 巨型 CSS，样式可控性差。
4. 缺少测试与工程化约束，改动容易引入回归。

结论：**有必要重构**，但采用“新仓渐进替换”而不是“原仓推倒重来”。

---

## 3. 仓库与分支策略

### 3.1 仓库策略

1. 旧仓：继续作为线上稳定版本与紧急修复仓（Legacy）。
2. 新仓：`2048-next`，仅用于重构与新架构开发。
3. 旧仓归档时机：新仓切流后稳定运行 >= 2 周再归档。

### 3.2 分支模型（新仓）

1. `main`：稳定可发布分支。
2. `develop`：日常集成分支。
3. `feature/*`：功能分支（如 `feature/core-engine`）。
4. `release/*`：发布候选分支（可选）。
5. `hotfix/*`：线上紧急修复分支。

---

## 4. 重构目标（验收标准）

1. 功能等价：经典/无撤回/封顶/练习板/回放/历史/模式页可用。
2. 数据兼容：旧 replay 字符串与关键本地存档可迁移或可导入。
3. 架构解耦：核心引擎层不直接依赖 DOM。
4. 自动化验证：核心规则、回放、撤回具备单测。
5. 移动端体验：`320/360/390/768/1024+` 无横向滚动。

---

## 5. 里程碑计划（M0-M8）

| 里程碑 | 目标 | 核心交付物 | 预计工期 |
|---|---|---|---|
| M0 | 初始化工程与规范 | 新仓骨架、Lint、Test、CI、PR模板 | 1-2 天 |
| M1 | 核心引擎解耦 | `core engine`（无 DOM）、规则单测 | 3-5 天 |
| M2 | 回放与兼容层 | 回放编解码、旧格式导入兼容测试 | 2-3 天 |
| M3 | 对局页接入 | game 页面适配层、核心交互可用 | 3-5 天 |
| M4 | 练习板接入 | 自定义放砖/直通/手势/移动端逻辑 | 3-4 天 |
| M5 | 工具页接入 | replay/history/modes 页面完成 | 2-3 天 |
| M6 | 主题系统重构 | 主题配置与渲染解耦、样式整理 | 2-3 天 |
| M7 | 全量回归 | 功能矩阵验收、缺陷修复清零 | 2-3 天 |
| M8 | 灰度与切流 | `/next` 灰度、切主路径、回滚预案验证 | 1-2 天 |

---

## 6. 每个里程碑的 DoD（完成定义）

每个里程碑必须同时满足：

1. 代码已合入 `develop`，且 CI 通过。
2. 对应测试用例通过（新增功能必须有测试）。
3. 已更新迁移记录与变更文档。
4. 已完成最小回归（桌面 + 移动关键页面）。
5. 可回滚（tag 或清晰回退 commit）。

---

## 7. 任务拆解（WBS）

### 7.1 Core 引擎

- [ ] Grid/Tile/Move/Merge 纯逻辑抽离
- [ ] Pow2 与 Fibonacci 规则模块化
- [ ] Undo 栈策略独立
- [ ] RNG 与出数策略独立（含自定义 4 率）

### 7.2 Replay

- [ ] 回放动作协议抽象
- [ ] 旧版本 replay 导入兼容层
- [ ] seek/rewind/速度控制稳定

### 7.3 UI 适配层

- [ ] 引擎状态 -> DOM 渲染映射
- [ ] 输入事件（键盘/触摸/按钮）统一适配
- [ ] 模态框与顶部按钮解耦

### 7.4 练习板

- [ ] 自定义放砖逻辑与手势模式
- [ ] 直通练习板状态迁移
- [ ] 移动端防误触与布局稳定

### 7.5 样式系统

- [ ] 内联样式迁移到组件样式
- [ ] 页面作用域选择器治理
- [ ] 断点策略统一（<=980、>980）

### 7.6 质量保障

- [ ] 单元测试（规则、撤回、概率、回放）
- [ ] E2E 关键流程测试（可用 Playwright）
- [ ] 发布前回归清单执行

---

## 8. 项目看板模板（建议用于 GitHub Projects）

列建议：

1. Backlog
2. Ready
3. In Progress
4. In Review
5. Testing
6. Done
7. Blocked

Issue 模板建议字段：

1. 背景
2. 目标
3. 范围（In/Out）
4. 验收标准
5. 风险与回滚
6. 关联里程碑

---

## 9. 命名与提交规范

### 9.1 分支命名

1. `feature/<domain>-<short-desc>`
2. `fix/<domain>-<short-desc>`
3. `chore/<short-desc>`

### 9.2 Commit 规范（建议）

1. `feat(core): ...`
2. `fix(practice): ...`
3. `refactor(ui): ...`
4. `test(replay): ...`
5. `docs(plan): ...`

---

## 10. 风险清单与缓解

| 风险 | 影响 | 概率 | 缓解策略 |
|---|---|---|---|
| 重构中断线上修复 | 高 | 中 | 旧仓保留 `legacy-maintenance` |
| 回放兼容失败 | 高 | 中 | 优先完成兼容层与回放回归集 |
| 移动端样式回归 | 中 | 高 | 固定视口矩阵验收与截图对比 |
| 重构周期失控 | 中 | 中 | 每个里程碑必须有 DoD 与时间盒 |
| 数据迁移异常 | 高 | 低 | 版本化存储键 + 灰度验证 |

---

## 11. 测试与验收矩阵

### 11.1 视口矩阵

1. `320x568`
2. `360x740`
3. `390x844`
4. `768x1024`
5. `>=1024`

### 11.2 核心流程矩阵

1. 开始新局 -> 移动 -> 撤回 -> 重试
2. 回放导入 -> 播放/暂停 -> 步进 -> 拖动进度
3. 直通练习板 -> 放砖 -> 置空手势 -> 重开
4. 概率模式 4 率（0/20/37/100）
5. 横竖屏切换后棋盘渲染对齐

---

## 12. 发布、切流、回滚方案

### 12.1 灰度发布

1. 新版本先部署到 `/next`（或子域）。
2. 小流量验证核心路径。
3. 通过后切换主入口。

### 12.2 回滚方案

1. 保留旧静态资源路径与版本。
2. 保留旧仓维护分支可快速补丁。
3. 切流首周每次发布均打 tag。

---

## 13. 操作清单（从今天开始）

### Week 1（可直接执行）

- [ ] 创建新仓 `2048-next`
- [ ] 建立 `main/develop` 分支
- [ ] 配置 Lint + Test + CI
- [ ] 搭建 `src/core` 骨架
- [ ] 迁移并验证最小移动/合并规则
- [ ] 建立回放兼容测试样例集

### Week 2

- [ ] 完成引擎可驱动基础 game 页
- [ ] 接入撤回、重开、计分、计时基础
- [ ] 首轮移动端适配回归

---

## 14. 变更日志（本文件）

### v1（2026-02-23）

1. 初始化重构管理框架
2. 定义仓库策略与里程碑
3. 给出可执行任务清单与风险控制

