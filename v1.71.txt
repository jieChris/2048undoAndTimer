v1.7 更新日志（相对 v1.61 的汇总）

一、回放与对局记录
1. 回放系统重构为 128 字符编码方案，核心目标是去种子化、提高复现稳定性。
2. 回放导入/导出链路重写，修复了历史上“路径回放不一致、错位、随机偏移”等问题。
3. 自动上传与历史写入流程补强，修复了 `invalid duration_ms` 导致上传失败的问题。
4. 历史对局展示增强：支持显示模式信息、终盘棋盘、回放入口、挑战信息等。

二、后端与账号体系（MySQL）
1. 新增后端服务（Fastify + MySQL）：注册、登录、刷新令牌、登出、鉴权等完整账号流程。
2. 新增成绩提交与服务端复算校验（Worker 队列），仅 `verified` 对局进入排行榜。
3. 新增用户历史查询接口、会话详情接口、每日挑战接口与挑战榜接口。
4. 数据库迁移体系完善：基础表、索引、模式重构、挑战扩展均已纳入迁移脚本。

三、排行榜体系升级
1. 排行榜从“固定三桶”升级为支持 `mode_key` 查询。
2. 现版本支持：所有不可撤回模式均可单独排行（每个模式一张独立榜单）。
3. 前端排行榜页面改为动态模式列表，自动读取可排行模式并切换查询。

四、模式系统与玩法扩展
1. 完成 `mode_key` 统一驱动，支持前后端一致的模式定义与校验。
2. 新增/整合玩法：
   - 标准无撤回 4x4、经典可撤回 4x4、封顶 2048
   - 4x3、4x2、3x3
   - 5x5 ~ 10x10 尺寸梯度
   - Fibonacci（4x4/3x3/4x3/4x2）
   - 概率变种（95/5、80/20）
   - 封顶 1024、封顶 4096
   - 方向锁、障碍块、限次撤回、连击加分等实验规则
3. 模式选择页重构：先按“可撤回/不可撤回”大类，再按玩法类型细分。
4. 首页定位为无撤回版本，并新增可撤回入口模式，整体布局保持一致风格。

五、撤回、统计与计时体系
1. 撤回能力改为“按模式规则控制 + 开局前限制切换”的机制。
2. 新增统计汇总面板（按钮打开）：总步数、移动步数、撤回步数、出砖统计与实际概率。
3. 出砖统计适配不同规则：2 幂模式显示 2/4，Fibonacci 模式显示 1/2。
4. 右侧计时栏新增“计时器模式 / 排行榜模式”切换：
   - 可在设置中切换
   - 排行榜模式即使无数据也保持原计时器区域占位
   - 标题改为“排行榜”，并已接入主题配色适配
5. 计时器逻辑继续支持多模式里程碑显示与特殊模式扩展。

六、最佳分与本地存储
1. 最高分改为按 `mode_key` 独立存储，不再全模式共用单一 best。
2. 各模式设置项（如右侧模块显示偏好）按模式分别持久化。

七、棋盘与布局修复
1. 修复了多尺寸棋盘（尤其非 4x4）网格不居中、背景框不匹配、对齐错误等问题。
2. 4x3、4x2 等棋盘增加了专门适配，避免强行套 4x4 模板导致错位。
3. 对介绍文案与顶部区域做了压缩与单行化，减少换行引发的棋盘下移。

八、主题系统升级
1. 主题从“仅棋子”扩展为“全界面适配”：页面背景、面板、按钮、计时模块、排行榜模块。
2. 霓虹主题优化：修复影响方块移动/合成动画的问题，保留炫彩风格并降低干扰。
3. 主题切换时，计时器与右侧排行榜模块会同步应用当前主题风格。

九、页面与交互整理
1. 首页顶部按钮体系调整（统计/导出回放/高级回放/模式选择/设置等）并保持主布局稳定。
2. 练习板、模式页、历史页、排行榜页、账号页协同联动增强。
3. 设置面板清理：已移除“撤回功能切换”旧入口，避免与新机制重复。

十、工程与部署侧改进
1. 前端与后端联调链路完善：本地 API 地址、健康检查、失败提示、离线补传机制。
2. 关键脚本与样式版本号持续递增，降低缓存导致的“修改不生效”问题。
3. MySQL 连接与迁移流程明确，支持宝塔场景部署。

——
备注：
- 本文档为“自 v1.61 之后到 v1.7 的汇总版”，采用主题分组，不按每个小补丁逐条拆分。
- 若需要，我可以再生成一份“按时间顺序（日誌式）”的细粒度 changelog。

==============================
v1.71 增量更新（最近修改）
==============================

一、后端新增导出 API（用户全量对局导出）
1. 新增接口：`GET /api/v1/users/:username/export`
2. 支持参数：
   - `format=json|ndjson`
   - `status=all|verified|pending|rejected`
   - `mode_key`（推荐）
   - `mode`（兼容旧字段）
   - `include_replay=true|false`
3. 导出内容包含：模式信息、分数、终盘棋盘、回放版本、回放数据（可选）、校验状态、结束时间等。
4. 接口增加下载头（`Content-Disposition`），浏览器可直接下载导出文件。
5. 增加导出接口限流配置，降低恶意高频导出风险。

二、导出能力兼容性增强
1. 在导出过滤条件中补充旧字段 `mode` 兼容逻辑，便于历史数据迁移期使用。
2. 在返回元信息与 filters 中同时写入 `mode_key` 与 `mode`，便于排查和离线处理。

三、文档补充
1. 新增文档：`backend/EXPORT_API.md`
2. 文档包含：
   - 接口地址与查询参数
   - JSON / NDJSON 返回结构
   - curl 调用示例
   - 常见错误说明（如 `user_not_found`、`invalid_status`）
3. 在 `backend/README.md` 中补充导出 API 条目并加入文档入口链接。
